<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMS Transaction Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Calm Neutral Tones -->
    <!-- Application Structure Plan: A two-part SPA structure is used. The default view is a "Dashboard" for high-level summary information (volume, trends, distribution). A secondary view, the "Transaction Explorer," allows for detailed, focused analysis through a filterable and paginated list. Clicking a transaction opens a modal for its full details. This structure separates 'at-a-glance' insights from 'deep-dive' exploration, providing a clear user flow and preventing information overload. -->
    <!-- Visualization & Content Choices: Report Info: Total transaction volume by type -> Goal: Inform -> Viz: Styled cards -> Interaction: None -> Justification: Quick, scannable summary stats. | Report Info: Monthly income vs. expenditure -> Goal: Compare/Change -> Viz: Bar Chart (Chart.js) -> Interaction: Hover tooltips -> Justification: Best for comparing two metrics over time. | Report Info: Distribution of payments/deposits -> Goal: Compare Proportions -> Viz: Doughnut Chart (Chart.js) -> Interaction: Hover tooltips -> Justification: Modern and clear for showing parts of a whole. | Report Info: Transaction List & Details -> Goal: Organize/Inform -> Viz: Responsive HTML Table & Modal -> Interaction: Filtering, Pagination, Click-to-view -> Justification: Efficient for browsing large datasets and drilling into specifics without losing context. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto; height: 350px; max-height: 400px; }
        @media (max-width: 768px) { .chart-container { height: 300px; } }
        .nav-link-active { border-bottom-color: #3b82f6; color: #3b82f6; }
        .nav-link-inactive { border-bottom-color: transparent; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Transaction Analyzer</h1>
            <p class="text-gray-600">Your financial dashboard and transaction explorer.</p>
            <nav class="mt-6 border-b border-gray-200">
                <div class="flex items-center space-x-8">
                    <button id="nav-dashboard" class="py-4 px-1 border-b-2 font-medium text-sm nav-link-active">Dashboard</button>
                    <button id="nav-explorer" class="py-4 px-1 border-b-2 font-medium text-sm nav-link-inactive">Explorer</button>
                </div>
            </nav>
        </header>

        <main>
            <!-- Dashboard View -->
            <section id="view-dashboard">
                <div class="mb-8">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-1">Dashboard Overview</h2>
                    <p class="text-gray-600">A summary of your financial activity based on the latest data.</p>
                </div>

                <!-- Total Volume Cards -->
                <div id="totalVolumeContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
                    <!-- Cards will be injected by JS -->
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">Monthly Flow</h3>
                        <p class="text-sm text-gray-500 mb-4">A comparison of your income vs. expenditure over the last year.</p>
                        <div class="chart-container">
                            <canvas id="monthlySummaryChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">Funds Distribution</h3>
                        <p class="text-sm text-gray-500 mb-4">A breakdown of your payments and deposits by category.</p>
                        <div class="chart-container">
                            <canvas id="distributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Transaction Explorer View -->
            <section id="view-explorer" class="hidden">
                 <div class="mb-8">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-1">Transaction Explorer</h2>
                    <p class="text-gray-600">Search, filter, and review all your transactions in detail.</p>
                </div>

                <!-- Filters -->
                <div class="bg-white p-6 rounded-lg shadow-sm mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div>
                            <label for="filter-type" class="block text-sm font-medium text-gray-700">Type</label>
                            <select id="filter-type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option>All Types</option>
                                <!-- Options will be injected by JS -->
                            </select>
                        </div>
                        <div>
                            <label for="filter-start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                            <input type="date" id="filter-start-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="filter-end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                            <input type="date" id="filter-end-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="filter-apply" class="block text-sm font-medium text-transparent">Actions</label>
                            <button id="filter-apply" class="mt-1 w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Apply Filters</button>
                        </div>
                    </div>
                </div>

                <!-- Transaction List -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th scope="col" class="relative px-6 py-3"><span class="sr-only">View</span></th>
                                </tr>
                            </thead>
                            <tbody id="transaction-list" class="bg-white divide-y divide-gray-200">
                                <!-- Rows will be injected by JS -->
                            </tbody>
                        </table>
                    </div>
                     <!-- Pagination -->
                    <div id="pagination-controls" class="p-4 flex items-center justify-between border-t border-gray-200">
                        <!-- Pagination will be injected by JS -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Transaction Detail Modal -->
    <div id="modal-container" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-2" id="modal-title">Transaction Details</h3>
                <div id="modal-content" class="mt-2 px-7 py-3 text-left">
                    <!-- Details will be injected by JS -->
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-close" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // Mock Data based on API Contract
            const mockApiData = {
                transactions: [
                    { id: 1, type: 'Incoming Money', amount: 5000, timestamp: '2025-05-15T10:00:00Z', details: { from: 'John Doe', transaction_id: '123456', currency: 'RWF' } },
                    { id: 2, type: 'Payments to Code Holders', amount: 1500, timestamp: '2025-05-14T14:30:00Z', details: { to: 'Jane Smith', transaction_id: '789012', currency: 'RWF' } },
                    { id: 3, type: 'Airtime Bill Payments', amount: 3000, timestamp: '2025-05-12T16:00:00Z', details: { transaction_id: '345678', fee: 50, currency: 'RWF' } },
                    { id: 4, type: 'Withdrawals from Agents', amount: 20000, timestamp: '2025-04-28T12:00:00Z', details: { agent_name: 'Agent 007', agent_number: '250123456789', currency: 'RWF' } },
                    { id: 5, type: 'Internet and Voice Bundle Purchases', amount: 2000, timestamp: '2025-04-25T09:00:00Z', details: { bundle: '1GB', currency: 'RWF' } },
                    { id: 6, type: 'Incoming Money', amount: 15000, timestamp: '2025-04-20T11:00:00Z', details: { from: 'Alice', transaction_id: '987654', currency: 'RWF' } },
                    { id: 7, type: 'Bank Transfers', amount: 50000, timestamp: '2025-04-15T18:00:00Z', details: { to_bank: 'Bank of Kigali', to_account: '1000123', currency: 'RWF' } },
                    { id: 8, type: 'Cash Power Bill Payments', amount: 12500, timestamp: '2025-04-10T13:45:00Z', details: { meter_number: '04123456789', token: '1234-5678-9012-3456', currency: 'RWF' } },
                    { id: 9, type: 'Incoming Money', amount: 7500, timestamp: '2025-03-22T19:20:00Z', details: { from: 'Bob', transaction_id: '555444', currency: 'RWF' } },
                    { id: 10, type: 'Payments to Code Holders', amount: 4200, timestamp: '2025-03-18T08:00:00Z', details: { to: 'Groceries Store', transaction_id: '333222', currency: 'RWF' } },
                    { id: 11, type: 'Bank Deposits', amount: 100000, timestamp: '2025-03-10T15:00:00Z', details: { to_bank: 'Equity Bank', currency: 'RWF' } },
                    { id: 12, type: 'Incoming Money', amount: 2500, timestamp: '2025-02-15T12:00:00Z', details: { from: 'Charlie', transaction_id: '111000', currency: 'RWF' } },
                    { id: 13, type: 'Airtime Bill Payments', amount: 5000, timestamp: '2025-02-05T17:30:00Z', details: { transaction_id: '999888', fee: 50, currency: 'RWF' } },
                    { id: 14, type: 'Failed to Parse', amount: 0, timestamp: '2025-01-30T10:00:00Z', details: { raw_sms_body: 'Yello! Your transfer of an unknown amount failed.', error_message: 'Amount not found' } },
                    { id: 15, type: 'Incoming Money', amount: 3000, timestamp: '2025-01-20T14:00:00Z', details: { from: 'David', transaction_id: '777666', currency: 'RWF' } },
                ],
                dashboardSummary: {
                    totalVolumeByType: [],
                    monthlySummary: [],
                    distribution: { payments: {}, deposits: {} }
                }
            };
            
            const state = {
                transactions: [],
                filters: { type: 'All Types', startDate: '', endDate: ''},
                pagination: { currentPage: 1, limit: 7, totalPages: 1 }
            };

            const chartInstances = {};

            // --- DATA PROCESSING ---
            function processDataForDashboard(transactions) {
                const summary = {
                    totalVolumeByType: {},
                    monthlySummary: Array(12).fill(0).map((_, i) => ({ month: new Date(0, i).toLocaleString('default', { month: 'short' }), income: 0, expenditure: 0 })),
                    distribution: { payments: {}, deposits: {} }
                };

                const incomeTypes = ['Incoming Money', 'Bank Deposits'];
                const paymentTypes = [
                    'Payments to Code Holders', 'Airtime Bill Payments', 'Cash Power Bill Payments', 
                    'Withdrawals from Agents', 'Bank Transfers', 'Internet and Voice Bundle Purchases'
                ];

                transactions.forEach(tx => {
                    // Total Volume
                    if(tx.type !== 'Failed to Parse') {
                        summary.totalVolumeByType[tx.type] = (summary.totalVolumeByType[tx.type] || 0) + tx.amount;
                    }

                    const monthIndex = new Date(tx.timestamp).getMonth();

                    // Monthly Summary & Distribution
                    if (incomeTypes.includes(tx.type)) {
                        summary.monthlySummary[monthIndex].income += tx.amount;
                        summary.distribution.deposits[tx.type] = (summary.distribution.deposits[tx.type] || 0) + tx.amount;
                    } else if (paymentTypes.includes(tx.type)) {
                        summary.monthlySummary[monthIndex].expenditure += tx.amount;
                        summary.distribution.payments[tx.type] = (summary.distribution.payments[tx.type] || 0) + tx.amount;
                    }
                });

                mockApiData.dashboardSummary.totalVolumeByType = Object.entries(summary.totalVolumeByType).map(([type, totalAmount]) => ({ type, totalAmount }));
                mockApiData.dashboardSummary.monthlySummary = summary.monthlySummary;
                mockApiData.dashboardSummary.distribution = summary.distribution;
            }
            
            // --- UI RENDERING ---

            function renderDashboard() {
                renderTotalVolumeCards();
                renderMonthlySummaryChart();
                renderDistributionChart();
            }

            function renderTotalVolumeCards() {
                const container = document.getElementById('totalVolumeContainer');
                container.innerHTML = '';
                const { totalVolumeByType } = mockApiData.dashboardSummary;
                
                if (totalVolumeByType.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 col-span-full">No transaction data available to display volume.</p>`;
                    return;
                }
                
                totalVolumeByType.forEach(({ type, totalAmount }) => {
                    const card = `
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h4 class="text-sm font-medium text-gray-500 truncate">${type}</h4>
                            <p class="mt-1 text-3xl font-semibold text-gray-900">${totalAmount.toLocaleString('en-US')} RWF</p>
                        </div>`;
                    container.innerHTML += card;
                });
            }

            function renderChart(canvasId, type, data, options) {
                if (chartInstances[canvasId]) {
                    chartInstances[canvasId].destroy();
                }
                const ctx = document.getElementById(canvasId).getContext('2d');
                chartInstances[canvasId] = new Chart(ctx, { type, data, options });
            }

            function renderMonthlySummaryChart() {
                const { monthlySummary } = mockApiData.dashboardSummary;
                const data = {
                    labels: monthlySummary.map(d => d.month),
                    datasets: [
                        {
                            label: 'Income',
                            data: monthlySummary.map(d => d.income),
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Expenditure',
                            data: monthlySummary.map(d => d.expenditure),
                            backgroundColor: 'rgba(255, 99, 132, 0.6)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                };
                const options = {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { callback: value => `${value/1000}k` } } },
                    plugins: { legend: { position: 'top' } }
                };
                renderChart('monthlySummaryChart', 'bar', data, options);
            }
            
            function renderDistributionChart() {
                const { distribution } = mockApiData.dashboardSummary;
                const paymentData = { ...distribution.payments, ...distribution.deposits };
                
                const data = {
                    labels: Object.keys(paymentData),
                    datasets: [{
                        label: 'Distribution',
                        data: Object.values(paymentData),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)'
                        ],
                        hoverOffset: 4
                    }]
                };
                const options = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } };
                renderChart('distributionChart', 'doughnut', data, options);
            }

            function renderTransactionList() {
                const list = document.getElementById('transaction-list');
                list.innerHTML = '';
                const { currentPage, limit } = state.pagination;
                const start = (currentPage - 1) * limit;
                const end = start + limit;
                
                const filtered = getFilteredTransactions();
                state.pagination.totalPages = Math.ceil(filtered.length / limit);
                
                const paginated = filtered.slice(start, end);
                
                if (paginated.length === 0) {
                    list.innerHTML = `<tr><td colspan="4" class="text-center py-10 text-gray-500">No transactions found for the selected filters.</td></tr>`;
                } else {
                    paginated.forEach(tx => {
                        const row = document.createElement('tr');
                        row.className = "hover:bg-gray-50 cursor-pointer";
                        row.dataset.transactionId = tx.id;
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${tx.type}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">${tx.amount.toLocaleString('en-US')} RWF</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-500">${new Date(tx.timestamp).toLocaleDateString()}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <a href="#" class="text-blue-600 hover:text-blue-900">View</a>
                            </td>
                        `;
                        list.appendChild(row);
                    });
                }
                renderPaginationControls();
            }
            
            function renderPaginationControls() {
                const container = document.getElementById('pagination-controls');
                container.innerHTML = '';
                const { currentPage, totalPages } = state.pagination;

                if (totalPages <= 1) return;

                const prevDisabled = currentPage === 1 ? 'disabled' : '';
                const nextDisabled = currentPage === totalPages ? 'disabled' : '';

                container.innerHTML = `
                    <button id="prev-page" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" ${prevDisabled}>Previous</button>
                    <span class="text-sm text-gray-700">Page ${currentPage} of ${totalPages}</span>
                    <button id="next-page" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" ${nextDisabled}>Next</button>
                `;
            }

            function renderFilterOptions() {
                const select = document.getElementById('filter-type');
                const types = [...new Set(mockApiData.transactions.map(tx => tx.type))];
                types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    select.appendChild(option);
                });
            }
            
            function renderModal(transaction) {
                const modalContainer = document.getElementById('modal-container');
                const modalContent = document.getElementById('modal-content');
                
                let detailsHtml = `<ul class="space-y-2 text-sm">
                    <li><strong class="font-medium text-gray-600 w-24 inline-block">ID:</strong> ${transaction.id}</li>
                    <li><strong class="font-medium text-gray-600 w-24 inline-block">Type:</strong> ${transaction.type}</li>
                    <li><strong class="font-medium text-gray-600 w-24 inline-block">Amount:</strong> ${transaction.amount.toLocaleString('en-US')} RWF</li>
                    <li><strong class="font-medium text-gray-600 w-24 inline-block">Date:</strong> ${new Date(transaction.timestamp).toLocaleString()}</li>
                </ul><hr class="my-3">
                <h4 class="font-semibold text-gray-800 mb-2">Additional Details:</h4>
                <ul class="space-y-2 text-sm">`;
                
                for(const [key, value] of Object.entries(transaction.details)) {
                    detailsHtml += `<li><strong class="font-medium text-gray-600 w-24 inline-block capitalize">${key.replace('_', ' ')}:</strong> ${value}</li>`;
                }

                detailsHtml += `</ul>`;

                modalContent.innerHTML = detailsHtml;
                modalContainer.classList.remove('hidden');
            }
            
            // --- LOGIC & EVENT HANDLERS ---
            
            function getFilteredTransactions() {
                const { type, startDate, endDate } = state.filters;
                return state.transactions.filter(tx => {
                    const txDate = new Date(tx.timestamp);
                    const isTypeMatch = type === 'All Types' || tx.type === type;
                    const isStartDateMatch = !startDate || txDate >= new Date(startDate);
                    const isEndDateMatch = !endDate || txDate <= new Date(endDate);
                    return isTypeMatch && isStartDateMatch && isEndDateMatch;
                });
            }

            function handleFilterApply() {
                state.filters.type = document.getElementById('filter-type').value;
                state.filters.startDate = document.getElementById('filter-start-date').value;
                state.filters.endDate = document.getElementById('filter-end-date').value;
                state.pagination.currentPage = 1;
                renderTransactionList();
            }
            
            function navigate(page) {
                const dashboardView = document.getElementById('view-dashboard');
                const explorerView = document.getElementById('view-explorer');
                const navDashboard = document.getElementById('nav-dashboard');
                const navExplorer = document.getElementById('nav-explorer');
                
                if (page === 'dashboard') {
                    dashboardView.classList.remove('hidden');
                    explorerView.classList.add('hidden');
                    navDashboard.classList.replace('nav-link-inactive', 'nav-link-active');
                    navExplorer.classList.replace('nav-link-active', 'nav-link-inactive');
                } else {
                    dashboardView.classList.add('hidden');
                    explorerView.classList.remove('hidden');
                    navDashboard.classList.replace('nav-link-active', 'nav-link-inactive');
                    navExplorer.classList.replace('nav-link-inactive', 'nav-link-active');
                }
            }

            document.getElementById('nav-dashboard').addEventListener('click', () => navigate('dashboard'));
            document.getElementById('nav-explorer').addEventListener('click', () => navigate('explorer'));
            document.getElementById('filter-apply').addEventListener('click', handleFilterApply);
            
            document.getElementById('pagination-controls').addEventListener('click', e => {
                if (e.target.id === 'prev-page') {
                    if (state.pagination.currentPage > 1) {
                        state.pagination.currentPage--;
                        renderTransactionList();
                    }
                }
                if (e.target.id === 'next-page') {
                    if (state.pagination.currentPage < state.pagination.totalPages) {
                        state.pagination.currentPage++;
                        renderTransactionList();
                    }
                }
            });

            document.getElementById('transaction-list').addEventListener('click', e => {
                const row = e.target.closest('tr');
                if (!row) return;
                
                const transactionId = parseInt(row.dataset.transactionId);
                const transaction = state.transactions.find(tx => tx.id === transactionId);
                if (transaction) {
                    renderModal(transaction);
                }
            });
            
            document.getElementById('modal-close').addEventListener('click', () => {
                document.getElementById('modal-container').classList.add('hidden');
            });
            
             // --- INITIALIZATION ---
            function init() {
                state.transactions = mockApiData.transactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                processDataForDashboard(state.transactions);
                renderDashboard();
                renderFilterOptions();
                renderTransactionList();
            }

            init();
        });
    </script>
</body>
</html>
